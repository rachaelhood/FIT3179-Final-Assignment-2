{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 950,
  "height": 420,
  "padding": 5,


  "signals": [
    { "name": "yearSig", "value": 2018 }   
  ],

  "data": [
    {
      "name": "table",
      "url": "data/SharkAttacks_Population_Merged.csv",
      "format": { "type": "csv" },
      "transform": [
        { "type": "formula", "as": "YearN", "expr": "toNumber(datum['Year'])" },
        { "type": "filter", "expr": "datum.YearN == yearSig" },
        { "type": "formula", "as": "SpeciesN", "expr": "isValid(datum['Species ']) ? datum['Species '] : 'Unknown'" },
        { "type": "filter", "expr": "datum.SpeciesN != 'Unknown'" },
        { "type": "aggregate", "groupby": ["SpeciesN"], "ops": ["count"], "as": ["value"] },
        { "type": "filter", "expr": "datum.value > 0" }
      ]
    },
    {
      "name": "tree",
      "source": "table",
      "transform": [
        { "type": "nest", "keys": ["SpeciesN"] },
        {
          "type": "treemap",
          "field": "value",
          "size": [950, 420],
          "round": true,
          "padding": 1,
          "sort": {"field":"value","order":"descending"},
          "as": ["x0","y0","x1","y1","depth","children"]
        }
      ]
    },
    { "name": "leaves", "source": "tree", "transform": [ { "type": "filter", "expr": "!datum.children" } ] }
  ],

  "scales": [
    { "name": "color", "type": "ordinal",
      "domain": { "data": "leaves", "field": "SpeciesN" },
      "range": { "scheme": "tableau20" } }
  ],

  "marks": [
    { "type": "rect", "from": { "data": "leaves" },
      "encode": {
        "enter": {
          "x": {"field": "x0"}, "y": {"field": "y0"},
          "x2": {"field": "x1"}, "y2": {"field": "y1"},
          "fill": {"scale": "color", "field": "SpeciesN"},
          "stroke": {"value": "white"}
        },
        "update": { "opacity": { "value": 0.95 } },
        "hover":  { "opacity": { "value": 1 } }
      } },
    { "type": "text", "from": { "data": "leaves" },
      "encode": {
        "enter": {
          "x": {"signal": "(datum.x0 + datum.x1) / 2"},
          "y": {"signal": "(datum.y0 + datum.y1) / 2"},
          "align": {"value": "center"},
          "baseline": {"value": "middle"},
          "fill": {"value": "#111"},
          "fontSize": {"value": 12}
        },
        "update": {
          "text": { "signal": "datum.SpeciesN + ' (' + datum.value + ')'" },
          "opacity": { "signal": "(datum.x1 - datum.x0) > 80 && (datum.y1 - datum.y0) > 22 ? 1 : 0" }
        }
      } }
  ]
}
